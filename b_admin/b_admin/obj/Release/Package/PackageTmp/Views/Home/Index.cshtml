@{

    Layout = "~/Views/Shared/layout.cshtml";
    ViewBag.title = "تغییر محتوا";
}

<div class="modal fade" id="upimg" role="dialog">
    <div class="modal-dialog">

        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">تغییر تصویر</h4>
            </div>
            <div class="modal-body">
                <div style="overflow:scroll;width:100%;height:300px">
                    <img src="" id="bimg" />
                </div>
                <form enctype="multipart/form-data" id="upimg">

                    <label style="font-size:15px" class="btn btn-primary btn-block">
                        تغییر تصویر
                        <input id="selectedimg" type="file" accept="image/png, image/jpeg" class="pis" name="file" style="display:none" />
                    </label><br>

                    <input type="submit" id="sub" class="btn btn-success btn-block" value="ذخیره تصویر" style="display:none" />
                    <br><br>
                    <p style="text-align:center" id="imgalert"></p>
                </form>

                <p id="imgid" style="display:none"></p>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">بستن</button>
            </div>
        </div>

    </div>
</div>

<div class="row">
    <div class="col-xs-12">
        <div class="box">
            <div class="box-header">
                <h3 class="box-title">تغییر محتوای سایت</h3>

                <div class="box-tools">
                    <div class="input-group input-group-sm" style="width: 150px;">
                        <input type="text" name="table_search" class="form-control pull-right" placeholder="جستجو">

                        <div class="input-group-btn">
                            <button type="submit" class="btn btn-default"><i class="fa fa-search"></i></button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- /.box-header -->
            <div class="box-body table-responsive no-padding">
                <table class="table table-hover">

                    <thead>
                        <tr>

                            <th>عنوان</th>
                            <th>مقدار</th>
                            <th>عملیات</th>

                        </tr>
                    </thead>
                    <tbody id="tbl_comm">
                    </tbody>
                </table>
            </div>

            <div class="send">
                <input type="checkbox" id="send" value="ارسال به درب منزل">
                <label for="send"> ارسال به درب منزل</label>
                <div id="price">

                </div>
            </div>

            <!-- /.box-body -->
        </div>
        <!-- /.box -->
    </div>
</div>



@section scripts{

    <script>
        $(document).ready(function () {
            $.post("/Home/getcomm")
                .done(function (res) {
                    if (res.state) {
                        $("#tbl_comm").empty();

                        for (var item in res.m) {

                            $("#tbl_comm").append(
                                '<tr>' +
                                '<td>' + res.m[item].Name + '</td>' +
                                '<td id="v_' + res.m[item].pkID + '"> ' + res.m[item].Valuee + '</td > ' +
                                '<td>' + '<button id="eb_' + res.m[item].pkID + '_' + res.m[item].Typee + '" onclick="chgval(this.id)" class="btn btn-warning"> ویرایش </button>' + '</td>' +
                                '</tr>'


                            );

                        }
                    }
                    else {
                        swal("عملیات ناموفق", res.m, "error");
                    }

                })
                .fail(function () {

                    swal("عملیات ناموفق", "خطا در برقراری ارتباط با سرور", "error");

                })
                .always(function () {

                });



            $(document).on('change', '.pis', function (e) {

                // var a = $(this).attr("id");

                //var b = a.split("_");
                var tgt = e.target || window.event.srcElement;
                files = tgt.files;

                // FileReader support
                if (FileReader && files && files.length) {
                    var fr = new FileReader();
                    fr.onload = function () {
                        var c = "bimg";

                        document.getElementById(c).src = fr.result;
                    }
                    fr.readAsDataURL(files[0]);
                }

                // Not supported
                else {
                    swal("عملیات ناموفق", "خطا در دریافت فایل", "error");
                }

                var filename = this.value;



                var file = this.files[0];



                //var filetype = getExtension(filename).toLowerCase();
                if (file.size > 3000000) {

                    var c = "imgalert";

                    document.getElementById(c).innerHTML = "حجم تصویر نباید بزرگتر از 3 مگا بایت باشد";
                    document.getElementById(c).style.color = "red";
                    document.getElementById(c).style.fontSize = "14px";

                }

                else {
                    var c = "imgalert";
                    var d = "sub";
                    document.getElementById(c).innerHTML = file.name;
                    document.getElementById(c).style.color = "green";
                    document.getElementById(c).style.fontSize = "14px";
                    document.getElementById(d).style.display = "block";

                }

            });



            $(document).on('click', '#sub', function (e) {
                e.preventDefault();

                var a = $("#imgid").html();
                var b = a.split("_");


                var data = new FormData();
                var file = $("#selectedimg").get(0).files;
                if (file.length > 0) {
                    data.append("image", file[0]);
                }
                var token = $('input[name="__RequestVerificationToken"]').val();


                data.append("__RequestVerificationToken", token);

                data.append("id", b[1]);
                //fi();


                $.ajax({
                    type: 'POST',
                    url: "/Home/chgimg",
                    data: data,
                    dataType: "json",
                    cache: false,
                    contentType: false,
                    processData: false,
                    success: function (res) {
                        if (res.state) {
                            swal("عملیات موفق", res.m, "success");

                            $("#imgsave_" + b[1]).css("display", "none");
                            $("#imgalert_" + b[1]).html("");
                        }
                        else {
                            swal("عملیات ناموفق", res.m, "error");
                        }
                        fd();
                    },
                    error: function () {
                        swal("عملیات ناموفق", "دقایقی دیگر امتحان کنید و در صورت وجود مشکل با ما تماس بگیرید", "error");

                    }




                });


            });

            $('.send').on('change', '#send', function (e) {               


                var state = $(this).is(':checked');
                if (state == true) {
                    $("#price").empty();
                    $("#price").append(

                        
                        '<button id="eb_20_text" onclick="chgval(this.id)" class="btn btn-outline-secondary"> هزینه ارسال را وارد کنید</button>'

                    );
                } else {
                    $("#price").empty();
                }
                $.post("/Home/send", {  state: state })

                    
            });



        });

        function chgval(id) {

            var token = $('input[name="__RequestVerificationToken"]').val();

            var a = id.split("_");

            if (a[2] == "img") {
                uploadimg(id);
            }
            else if (a[2] == "text") {

                swal({
                    text: 'مقدار مورد نظر را وارد کنید',
                    content: "input",
                    button: {
                        text: "اعمال",
                        closeModal: false,
                    },
                })
                    .then(name => {
                        if (!name) throw null;

                        $.post("/Home/commtblch", { id: a[1], valuee: name, __RequestVerificationToken: token })

                            .done(function (res) {
                                console.log(res);
                                if (res.state) {
                                    $("#v_" + a[1]).html(res.m);
                                    swal("عملیات موفق", "مقدار مورد نظر به روز رسانی شد", "success");
                                }
                                else {
                                    swal("خطا", res.m, "error");
                                }
                            })
                            .fail(function () {
                                swal("خطا", "عدم برقراری ارتباط با سرور", "error");
                            });
                    });
            } 
        }

        function uploadimg(id) {
            $("#imgid").html(id);
            $("#upimg").modal("show");
        }
        

  </script>



}


